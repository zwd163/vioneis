# 动态 IP 问题解决方案

## 需求概述

参考 `issues/DYNAMIC_IP_PROBLEM.md` 中的需求：

1. 服务器的 IP 可能会动态变化，导致前端无法连接到后端
2. 需要自动检测外网 IP，检测是否发生变化
3. 如果 IP 发生变化，记录此 IP，并将服务入口生成二维码
4. 将二维码发送到 staff(is_delete=False, is_lock=False) 的邮箱，让 staff 扫码登录

## 解决方案

我们实现了一个完整的动态 IP 监控服务，该服务作为 Web 服务器的一部分，随 Web 服务器自动启动和停止。服务定期检查服务器的公网 IP 地址，如果检测到变化，会自动向所有活跃的员工发送通知邮件。

### 主要功能

1. **IP 检测**：使用多种方法获取公网 IP 地址，确保检测的可靠性
2. **变化监控**：定期检查 IP 地址是否发生变化，默认每小时检查一次
3. **二维码生成**：当检测到 IP 变化时，生成包含新 IP 地址的访问链接二维码
4. **邮件通知**：向所有活跃的员工（is_delete=False, is_lock=False）发送通知邮件
5. **自动化集成**：服务随 Web 服务器自动启动和停止，无需手动干预
6. **状态管理**：提供命令行工具，可以查看服务状态、手动启动和停止服务

### 技术实现

1. **IP 检测模块**：
   - 使用多种方法获取公网 IP（ipify.org、ifconfig.me、socket 连接）
   - 如果一种方法失败，自动尝试其他方法

2. **二维码生成**：
   - 使用 qrcode 库生成二维码
   - 将二维码直接嵌入到邮件正文中，而不是作为附件发送

3. **邮件发送**：
   - 使用 Django 的邮件功能发送通知
   - 提供备用的 smtplib 方法，确保邮件发送的可靠性
   - 邮件中包含访问按钮和嵌入的二维码，不直接显示 IP 地址和端口

4. **后台服务**：
   - 使用 Python 的线程机制实现后台服务
   - 服务随 Web 服务器自动启动和停止
   - 使用数据库存储服务状态，实现跨进程状态共享

5. **管理命令**：
   - 提供 Django 管理命令，可以查看服务状态、手动启动和停止服务
   - 支持管理在其他进程中运行的服务实例

### 实现的文件

1. **utils/models.py**：
   - 创建 SystemSettings 模型，用于存储系统设置和服务状态

2. **utils/ip_monitor.py**：
   - 实现 IP 检测、二维码生成和邮件发送功能

3. **utils/ip_monitor_task.py**：
   - 实现后台服务的核心功能
   - 包括服务启动、停止、状态管理等

4. **utils/apps.py**：
   - 修改应用配置，使服务随 Web 服务器自动启动

5. **utils/management/commands/check_ip_change.py**：
   - 创建管理命令，用于手动检查 IP 变化

6. **utils/management/commands/test_ip_change.py**：
   - 创建测试命令，用于测试 IP 变化检测功能

7. **utils/management/commands/ip_monitor.py**：
   - 创建管理命令，用于管理 IP 监控服务

8. **docs/dynamic_ip_monitor.md**：
   - 创建功能文档，说明如何使用和配置服务

9. **docs/ip_monitor_service.md**：
   - 创建服务文档，详细说明服务的工作原理和管理方法

### 使用方法

1. **自动启动和停止**：
   - 当启动 Web 服务器时，IP 监控服务会自动启动：
     ```
     venv\Scripts\activate ; daphne -b 0.0.0.0 -p 8008 greaterwms.asgi:application
     ```
   - 当 Web 服务器停止时，IP 监控服务会自动停止

2. **查看服务状态**：
   ```
   python manage.py ip_monitor status
   ```

3. **手动启动服务**：
   ```
   python manage.py ip_monitor start
   ```

4. **手动停止服务**：
   ```
   python manage.py ip_monitor stop
   ```

5. **手动检查 IP 变化**：
   ```
   python manage.py check_ip_change
   ```

6. **测试功能**：
   ```
   python manage.py test_ip_change --force
   ```

### 配置选项

1. **检查间隔**：
   - 在 `settings.py` 中添加 `IP_CHECK_INTERVAL` 设置，单位为秒
   - 默认为 3600 秒（1 小时）

2. **邮件设置**：
   - 确保在 `settings.py` 中正确配置邮件发送设置
   - 包括 SMTP 服务器、端口、用户名、密码等

## 测试结果

1. **IP 检测**：成功使用多种方法获取公网 IP 地址
2. **服务启动和停止**：服务成功随 Web 服务器自动启动和停止
3. **邮件发送**：成功向活跃员工发送通知邮件，包含访问按钮和嵌入的二维码
4. **状态管理**：成功实现跨进程状态共享，可以准确查看服务状态

## 注意事项

1. **邮件配置**：确保正确配置邮件发送设置，否则通知邮件将无法发送
2. **网络连接**：服务器需要能够访问互联网，才能获取公网 IP 地址
3. **员工邮箱**：确保活跃员工的邮箱地址正确，否则通知邮件将无法送达
4. **服务状态**：如果需要查看服务的详细运行日志，可以查看 `logs/server.log` 文件

## 总结

这个解决方案提供了一个完整的动态 IP 监控服务，可以自动检测服务器 IP 变化并通知员工。服务作为 Web 服务器的一部分，随 Web 服务器自动启动和停止，无需手动干预。同时，服务也提供了方便的管理命令，可以查看服务状态、手动启动和停止服务。

这个解决方案满足了需求中的所有要求，并提供了额外的功能和灵活性，确保系统在服务器 IP 变化的情况下仍然可用。
